{% extends "base.html" %}
{% block content %}
<header>
  <script>
    window.addEventListener('load', function() {
        const el_search = document.getElementById("search_str");
        console.log(`onload(): search_str="${el_search.value}"`);
        if (el_search.value != "") {
            return;
        }

        const el = document.getElementById("cur_day");
        scrollToDate(location.pathname, el.value, "auto");
    });

    sc_flag = false;
    window.addEventListener('scroll', function() {
        if (sc_flag) {
            return;
        }
        const el_search = document.getElementById("search_str");
        //console.log(`onscroll:search_str="${el_search.value}"`);
        if (el_search.value != "") {
            return;
        }

        const y = window.pageYOffset;
        const tail = window.pageYOffset + window.innerHeight;
        const bodyH = document.body.clientHeight;
        console.log(`${y}-${bodyH - tail}`);
        
        if (y < 70) {
            sc_flag = true;
            el = document.getElementById("date_from");
            date = el.value;
            console.log(`date=${date}`);
            doPost('/ytsched/', {date: date, top_bottom: "top"});
        }
        if (bodyH - tail < 90) {
            sc_flag = true;
            el = document.getElementById("date_to");
            date = el.value;
            console.log(`date=${date}`);
            doPost('/ytsched/', {date: date, top_bottom: "bottom"});
        }
    }, {passive: true});
  </script>
                        
  <!-- menu bar -->
  <div class="container-fluid p-0 fixed-top my-bar">
    <div class="row m-0" style="z-index:100">

      <!-- home -->
      <div class="col-2 p-0 text-center">
        <!--
        <i class="fas fa-circle-notch fa-2x fa-spin"
           onmousedown="scrollToDate(
                        '{{ url_prefix }}', '{{ today }}');" ></i>
        -->
        <i class="fas fa-home fa-2x"
           onmousedown="scrollToDate(
                        '{{ url_prefix }}', '{{ today }}', 'auto');" ></i>
      </div><!-- col -->
      
      <!-- add -->
      <div class="col-2 p-0 text-center"
           onmousedown="doPost(
                        '{{ url_prefix + 'edit/' }}',
                        {date: '{{ date }}', sde_id: ''} );">
        <i class="fas fa-plus-square fa-2x"></i>
      </div><!-- col -->

      <!-- search -->
      <div class="col-6 p-0 text-center" style="font-size: medium;">
        <form id="form_search" name="form_search"
              action="{{ url_prefix }}" method="POST">

          {% if search_str %}
            {% set search_spin="fa-spin" %}
          {% else %}
            {% set search_spin="" %}
          {% end %}
          <input id="search_str" name="search_str" type="text" size="10"
                 style="font-size: medium; vertical-align: middle;"
                 value="{{ search_str }}" />
          <i class="fas fa-search fa-2x {{ search_spin }}"
             style="vertical-align: middle;"
             onmousedown="document.form_search.submit();"></i>

          <input id="cur_day" name="cur_day"
                 type="hidden" value="{{ date }}" />
        </form>
      </div><!-- col -->

      <!-- menu_sw -->
      <div class="col-2 p-0 text-center" style="font-size: x-small;">
        <label for="menu-sw" class="m-0">
          <i class="fas fa-bars fa-3x"></i></label>
      </div><!-- col -->

    </div><!-- row -->
    <input id="menu-sw" type="checkbox" style="display:none;">
    <div id="menu-content" class="row m-0 my-bar my-bar-content"
         style="z-index:80">

      <!-- date -->
      <div class="col-5 p-0 text-center">
        <input id="date" name="date"
               type="date" value="{{ date }}"
               onchange="doPost('{{ url_prefix }}',{date:this.value});"/>
      </div><!-- col -->
        
      <!-- ToDo days -->
      <div class="col-3 p-0 text-center">
        <form id="todo_days_form" name="todo_days_form"
              action="{{ url_prefix }}" method="POST">
          <i class="fas fa-list-alt fa-lg"
             style="vertical-align: middle;"></i>
          <select id="todo_days" name="todo_days"
                  style="vertical-align: middle;"
                  onchange="document.todo_days_form.submit();">
            {% for opt in todo_days_list %}
            {% if todo_days_list[opt] == todo_days_value %}
            <option value="{{ todo_days_list[opt] }}" selected>
              {{ opt }}
            </option>
            {% else %}
            <option value="{{ todo_days_list[opt] }}">
              {{ opt }}
            </option>
            {% end %}
            {% end %}
          </select>
        </form>
      </div><!-- col -->

      <!-- filter -->
      <div class="col-4 p-0 text-center" style="font-size: small;">
        <form id="form_filter" name="form_filter"
              action="{{ url_prefix }}" method="POST">
          <input id="filter_str" name="filter_str" type="text" size="5"
                 style="vertical-align: middle;"
                 value="{{ filter_str }}" />
          <i class="fas fa-filter fa-2x" style="vertical-align: middle;"
             onmousedown="document.form_filter.submit();"></i>
          <input name="cur_day"
                 type="hidden" value="{{ date }}" />
        </form>
      </div><!-- col -->
          
      <div class="col-12" style="height: 5px;">
        &nbsp;
      </div>

      <div class="col-5" style="font-size: small;">
        Version {{ version }}
      </div>
      <div class="col-7 text-right" style="font-size: small">
        (c) 2020 <strong>{{ author }}</strong>
      </div>
    
    </div><!-- row -->        

  </div><!-- container -->
</header>
<main style="background-color:#FFF;padding-top: 65px;">
  <div class="container-fluid p-0">
    
    <input id="top_bottom" name="top_bottom"
           type="hidden" value="{{ top_bottom }}" />
    <input id="date_from" name="date_from"
           type="hidden" value="{{ date_from }}" />
    <input name="cur_day"
           type="hidden" value="{{ date }}" />
    <input id="date_to" name="date_to"
           type="hidden" value="{{ date_to}}" />

    {% if search_str %}

        {% set date_from2 = str(date_from).replace('-','/') %}
        {% set date_to2 = str(date_to).replace('-','/') %}
        {% set date2 = str(date).replace('-', '/') %}
        {% set delta_from = (date_from - date) / date.resolution %}
        {% set delta_to = (date_to - date) / date.resolution %}

    <div class="row m-0" style="background-color:#EEE;">
      <div class="col-1">
      </div>
      <div class="col-2 p-0 text-right">
        <div class="container-fluid p-0" style="opacity: 0.8;">
          <div class="row m-0"
               onmousedown="doPostDate('{{ url_prefix }}', '{{ date }}', -365);" >
            <div class="col p-0 text-center">
              <i class="fas fa-arrow-alt-circle-up fa-2x"></i>
            </div>
          </div>
          <div class="row" style="font-size: xx-small">
            <div class="col p-0 text-center">
             &nbsp;
            </div>
          </div>
          <div class="row"
               onmousedown="doPostDate('{{ url_prefix }}', '{{ date }}', +365);">
            <div class="col p-0 text-center">
              <i class="fas fa-arrow-alt-circle-down fa-2x"></i>
            </div><!-- col -->
          </div><!-- row -->
        </div><!-- container -->
      </div><!-- col -->
      <div class="col-1">
      </div>
      <div class="col-8 p-0 text-center">
        <input type="date" value="{{ date_from }}"
               onchange="doPostDate('{{ url_prefix }}', this.value, 365);" />
        <br />
        <i class="fas fa-arrows-alt-v"></i>
        <br />
        <input type="date" value="{{ date_to }}"
               onchange="doPostDate('{{ url_prefix }}', this.value, -365);" />             
      </div>
    </div>
    {% end %}

    {% set sde_count = 0 %}
    {% set year=0 %}

    {% for sched_ent in sched %}

    {% set sched_date = sched_ent['date'] %}

    <!-- {{ date }} -->
    {% if sched_date == today %}
      {% set today_flag = True %}
    {% else %}
      {% set today_flag = False %}
    {% end %}

    {% if today_flag %}
      {% set border = 'border: 3px solid #0FF !important;' %}
    {% else %}
      {% set border = 'border: 1px solid #888 !important;' %}
    {% end %}

    {% if search_str %}
      {% if int(sched_date.year) != int(year) %}
        {% set year=sched_date.year %}
        <strong>{{ year }}</strong>
      {% end %}
    {% end %}
    <div id="date-{{ sched_date }}"
         class="row p-0 m-0 border rounded"
         style="background-color:#EEE;{{ border }}">

      <!-- 日付 -->
      {% set weekday = sched_date.weekday() %}
      {% set bg_color = '#EFF' %}
      {% if weekday == 0 %}
        {% set bg_color = '#EFFFFF' %}
      {% end %}
      {% if weekday == 1 %}
        {% set bg_color = '#E4F8FE' %}
      {% end %}
      {% if weekday == 2 %}
        {% set bg_color = '#E0EFFD' %}
      {% end %}
      {% if weekday == 3 %}
        {% set bg_color = '#D4EBFC' %}
      {% end %}
      {% if weekday == 4 %}
        {% set bg_color = '#D0E0FB' %}
      {% end %}
      {% if weekday == 5 %}
        {% set bg_color = '#C0D4FA' %}
      {% end %}
      {% if weekday == 6 %}
        {% set bg_color = '#FFCCCC' %}
      {% end %}

      {% if sched_ent['is_holiday'] %}
        {% set bg_color = '#F88' %}
      {% end %}

      {% set url = url_prefix %}
      {% set obj = {'date': str(sched_date) } %}
      <div class="col-1 p-0 text-center"
           style="background-color:{{ bg_color }};"
           onmousedown="doPost({{ url }}, {{ obj }});">

        <div class="row p-0 m-0"
             style="font-size: xx-small; font-weight: unset;">
          <div class="col p-0 m-0 text-left">
            &nbsp;{{ sched_ent['date'].month }} /
          </div>
        </div>

        {% if today_flag %}
          {% set font_size = 'large' %}
          {% set font_weight = 'bold' %}
        {% else %}
          {% set font_size = 'medium' %}
          {% set font_weight = 'unset' %}
        {% end %}
        <div class="row p-0 m-0"
             style="font-size: {{ font_size }};
                    font-weight: {{ font_weight }};">
          <div class="col p-0 text-center">
            {{ sched_date.day }}
          </div>
        </div>
        <div class="row p-0 m-0"
             style="font-size: x-small; font-weight: unset;">
          <div class="col p-0 text-right">
            ({{ sched_date.strftime('%a') }})
          </div>
        </div>
      </div><!-- col -->

      <!-- スケジュール -->
      <div class="col-11 p-0">
        <!-- Normal Schedule -->
        {% for sde in sched_ent['sde'] %}
          {% include sde.html %}
        {% end %}
        
        {% if today_flag and todo_days_value %}
          <!-- ToDo -->
          {% for sde in todo %}
            {% if sde.date <= today + delta_day1 * todo_days_value %}
              {% include sde.html %}
            {% end %}<!-- if sde.date -->
          {% end %}<!-- for sde -->
        {% end %}<!-- if today_flag and todo_days_value -->
         <div class="text-center" style="opacity: .4;"
           onmousedown="doPost(
                        '{{ url_prefix + 'edit/' }}',
                        {date: '{{ sched_date }}', sde_id: ''} );">
           <i class="fas fa-plus-square"></i>
         </div>                              
      </div><!-- col -->
    </div><!-- row -->

    {% end %}<!-- for sched_ent -->

  </div><!-- container -->
</main>
{% end %}
